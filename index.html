<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å®¶åº­æ™ºæ…§</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Remix Icon -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <style>
        /* Apple San Francisco å­—ä½“å›é€€ */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Arial, sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        
        /* éšè—æ»šåŠ¨æ¡ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ç£¨ç ‚ç»ç’ƒ */
        .glass-nav {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        /* æå…‰èƒŒæ™¯åŠ¨ç”» */
        .aurora-bg {
            background: radial-gradient(circle at 50% 0%, rgba(100, 180, 255, 0.15) 0%, rgba(255, 255, 255, 0) 50%),
                        radial-gradient(circle at 0% 0%, rgba(200, 100, 255, 0.05) 0%, rgba(255, 255, 255, 0) 40%);
        }

        /* å¡ç‰‡å…¥åœºåŠ¨ç”» */
        .card-enter {
            animation: cardPopup 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            opacity: 0;
            transform: translateY(20px) scale(0.96);
        }
        @keyframes cardPopup {
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* æ˜Ÿæ˜Ÿç‚¹å‡»åŠ¨ç”» */
        .star-anim:active { transform: scale(1.3); }
    </style>
</head>
<body class="bg-[#F2F2F7] text-[#1D1D1F] min-h-screen pb-32 aurora-bg">

    <div id="app">
        
        <!-- 1. é¡¶éƒ¨ Header (å±…ä¸­ + ç§‘æŠ€æ„Ÿ) -->
        <header class="sticky top-0 z-40 glass-nav pt-safe-top transition-all duration-300">
            <div class="px-6 pt-4 pb-4 text-center relative">
                <p class="text-[10px] font-bold text-blue-500 tracking-[0.2em] uppercase mb-1 opacity-80">Family Wisdom</p>
                <h1 class="text-2xl font-black tracking-tight text-black flex items-center justify-center gap-2">
                    <i class="ri-home-heart-fill text-blue-500"></i> å®¶åº­æ™ºæ…§
                </h1>
            </div>

            <!-- ç­›é€‰åŒºï¼šå…¨æ˜¾ç¤ºï¼Œä¸æ»‘åŠ¨ -->
            <div class="px-4 pb-4">
                <!-- ç¬¬ä¸€è¡Œï¼šåˆ†ç±» (Wrap) -->
                <div class="flex flex-wrap justify-center gap-2 mb-3">
                    <button 
                        v-for="cat in categories" 
                        :key="cat"
                        @click="currentCategory = cat"
                        class="px-3 py-1.5 rounded-full text-xs font-bold transition-all duration-200 border"
                        :class="currentCategory === cat 
                            ? 'bg-black text-white border-black shadow-md transform scale-105' 
                            : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'"
                    >
                        {{ cat }}
                    </button>
                </div>

                <!-- ç¬¬äºŒè¡Œï¼šå‘å¸ƒè€…ç­›é€‰ (ä¸‹æ‹‰å¼ï¼ŒèŠ‚çœç©ºé—´) -->
                <div class="flex justify-center">
                    <div class="relative inline-block">
                        <select v-model="currentMember" class="appearance-none bg-white/50 border border-gray-200 rounded-lg pl-3 pr-8 py-1 text-xs font-bold text-gray-600 focus:outline-none focus:border-blue-500">
                            <option value="å…¨éƒ¨æˆå‘˜">ğŸ‘¤ å…¨éƒ¨æˆå‘˜</option>
                            <option v-for="m in members" :value="m">{{ m }}</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                            <i class="ri-arrow-down-s-fill text-xs"></i>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- 2. åˆ—è¡¨åŒºåŸŸ -->
        <main class="px-4 py-4 space-y-5 max-w-xl mx-auto">
            
            <!-- åŠ è½½çŠ¶æ€ -->
            <div v-if="loading" class="flex flex-col items-center justify-center py-20 opacity-50 space-y-4">
                <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                <p class="text-xs font-mono tracking-widest">LOADING...</p>
            </div>

            <!-- ç©ºçŠ¶æ€ -->
            <div v-if="!loading && filteredList.length === 0" class="text-center py-20 opacity-40">
                <div class="bg-gray-200 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="ri-search-2-line text-3xl text-gray-400"></i>
                </div>
                <p>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ™ºæ…§</p>
                <button @click="resetFilters" class="text-blue-500 text-sm mt-2 font-bold">æŸ¥çœ‹å…¨éƒ¨</button>
            </div>

            <!-- å¡ç‰‡ -->
            <div 
                v-for="(item, index) in filteredList" 
                :key="item.id"
                class="card-enter bg-white rounded-[24px] shadow-[0_10px_40px_-10px_rgba(0,0,0,0.08)] overflow-hidden cursor-pointer active:scale-[0.98] transition-transform duration-200 border border-white/50"
                :style="{ animationDelay: index * 0.05 + 's' }"
                @click="openDetail(item)"
            >
                <!-- å¡ç‰‡å°é¢ (å¦‚æœæœ‰å›¾/è§†é¢‘) -->
                <div v-if="item.content_type === 'image'" class="h-48 w-full bg-gray-100 relative">
                    <img :src="item.content" class="w-full h-full object-cover">
                    <div class="absolute top-3 right-3 bg-black/50 backdrop-blur text-white text-[10px] px-2 py-1 rounded-md font-bold">
                        <i class="ri-image-fill"></i> å›¾ç‰‡
                    </div>
                </div>
                <div v-else-if="item.content_type === 'video'" class="h-48 w-full bg-black relative flex items-center justify-center">
                    <i class="ri-play-circle-fill text-white text-5xl opacity-80"></i>
                    <div class="absolute top-3 right-3 bg-black/50 backdrop-blur text-white text-[10px] px-2 py-1 rounded-md font-bold">
                        <i class="ri-movie-fill"></i> è§†é¢‘
                    </div>
                </div>

                <!-- å¡ç‰‡æ–‡æœ¬ -->
                <div class="p-5">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded-md">{{ item.category }}</span>
                        <span class="text-[10px] text-gray-400 font-mono">{{ formatDate(item.created_at) }}</span>
                    </div>

                    <h3 class="text-xl font-bold text-[#1D1D1F] leading-tight mb-2">{{ item.title }}</h3>
                    
                    <p v-if="item.content_type === 'text'" class="text-sm text-gray-500 line-clamp-2 mb-4">
                        {{ item.content }}
                    </p>

                    <!-- åº•éƒ¨ï¼šä½œè€… + è¯„åˆ† -->
                    <div class="flex items-center justify-between pt-3 border-t border-gray-100 mt-2">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full bg-gradient-to-tr from-gray-200 to-gray-300 flex items-center justify-center text-[10px] font-bold text-gray-600">
                                {{ item.member_name.charAt(0) }}
                            </div>
                            <span class="text-xs font-bold text-gray-600">{{ item.member_name }}</span>
                        </div>

                        <!-- æ˜Ÿçº§å±•ç¤º -->
                        <div class="flex items-center gap-1" @click.stop="startRating(item)">
                            <i class="ri-star-fill text-yellow-400 text-sm"></i>
                            <span class="text-xs font-bold text-gray-700">{{ (item.rating_sum / (item.rating_count || 1)).toFixed(1) }}</span>
                            <span class="text-[10px] text-gray-400">({{ item.rating_count }})</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 3. Apple é£æ ¼æ‚¬æµ®æŒ‰é’® (çµåŠ¨å²›é£æ ¼) -->
        <div class="fixed bottom-8 left-0 right-0 flex justify-center z-40 pointer-events-none">
            <button 
                @click="showModal = true"
                class="pointer-events-auto bg-black/90 backdrop-blur-xl text-white pl-5 pr-6 py-3.5 rounded-full shadow-2xl flex items-center gap-3 active:scale-90 transition-all duration-300 hover:bg-black"
            >
                <div class="w-6 h-6 rounded-full bg-white text-black flex items-center justify-center">
                    <i class="ri-add-line font-bold"></i>
                </div>
                <span class="font-bold text-sm tracking-wide">è®°å½•æ–°æ™ºæ…§</span>
            </button>
        </div>

        <!-- 4. å‘å¸ƒå¼¹çª— (ä¿®å¤é®æŒ¡é—®é¢˜) -->
        <div v-if="showModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center">
            <div class="absolute inset-0 bg-black/30 backdrop-blur-sm transition-opacity" @click="showModal = false"></div>
            
            <div class="bg-white w-full h-[92vh] sm:h-auto sm:max-w-lg sm:rounded-3xl rounded-t-[32px] shadow-2xl z-10 flex flex-col overflow-hidden animate-[slideUp_0.4s_cubic-bezier(0.16,1,0.3,1)]">
                
                <!-- é¡¶éƒ¨æ  (åŠ å¤§äº† padding é˜²æ­¢é®æŒ¡) -->
                <div class="pt-6 pb-4 px-6 border-b border-gray-100 flex justify-between items-center bg-white/80 backdrop-blur z-20 sticky top-0">
                    <h2 class="text-lg font-black text-black">New Wisdom</h2>
                    <button @click="showModal = false" class="bg-gray-100 text-gray-500 rounded-full w-8 h-8 flex items-center justify-center hover:bg-gray-200">
                        <i class="ri-close-line text-xl"></i>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-6 space-y-8 pb-32">
                    
                    <!-- æ­¥éª¤æ¡ -->
                    <div class="flex items-center justify-between px-2">
                        <div v-for="i in 3" :key="i" class="h-1 rounded-full flex-1 mx-1" :class="step >= i ? 'bg-blue-500' : 'bg-gray-200'"></div>
                    </div>

                    <!-- 1. åŸºæœ¬ä¿¡æ¯ -->
                    <div class="space-y-4">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-widest">01. åŸºç¡€ä¿¡æ¯</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold mb-1.5 text-gray-500">å‘å¸ƒè€…</label>
                                <select v-model="form.member_name" class="w-full bg-gray-50 border-0 rounded-xl p-3 text-sm font-bold focus:ring-2 focus:ring-blue-500/20 outline-none">
                                    <option value="" disabled>é€‰æ‹©...</option>
                                    <option v-for="m in members" :value="m">{{ m }}</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-1.5 text-gray-500">åˆ†ç±»</label>
                                <select v-model="form.category" class="w-full bg-gray-50 border-0 rounded-xl p-3 text-sm font-bold focus:ring-2 focus:ring-blue-500/20 outline-none">
                                    <option value="" disabled>é€‰æ‹©...</option>
                                    <option v-for="c in availableCategories" :value="c">{{ c }}</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 2. å†…å®¹ç±»å‹ -->
                    <div class="space-y-4">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-widest">02. å†…å®¹å½¢å¼</p>
                        <div class="flex bg-gray-100 p-1 rounded-xl">
                            <button 
                                v-for="type in contentTypes" 
                                @click="form.content_type = type.val"
                                class="flex-1 py-2 rounded-lg text-xs font-bold transition-all duration-300"
                                :class="form.content_type === type.val ? 'bg-white text-black shadow-sm scale-100' : 'text-gray-400 scale-95'"
                            >
                                {{ type.label }}
                            </button>
                        </div>
                    </div>

                    <!-- 3. æ ¸å¿ƒå†…å®¹ -->
                    <div class="space-y-4">
                        <input type="text" v-model="form.title" placeholder="è¾“å…¥æ ¸å¿ƒæ ‡é¢˜..." class="w-full text-2xl font-black bg-transparent border-0 border-b-2 border-gray-100 py-2 focus:border-black focus:ring-0 placeholder-gray-300 transition-colors">
                        
                        <!-- ä¸Šä¼ ç»„ä»¶ -->
                        <div v-if="['image','video'].includes(form.content_type)" class="border-2 border-dashed border-gray-200 rounded-2xl p-8 text-center bg-gray-50 hover:bg-white hover:border-blue-300 transition-all relative overflow-hidden group">
                            <input type="file" @change="handleUpload" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            
                            <div v-if="uploading" class="flex flex-col items-center animate-pulse">
                                <i class="ri-upload-cloud-2-fill text-3xl text-blue-500"></i>
                                <span class="text-xs font-bold text-blue-500 mt-2">æ­£åœ¨ä¸Šä¼ åˆ°äº‘ç«¯...</span>
                            </div>
                            <div v-else-if="form.content" class="relative z-0">
                                <img v-if="form.content_type==='image'" :src="form.content" class="h-32 object-contain mx-auto rounded-lg shadow-sm">
                                <div v-else class="text-green-500 font-bold"><i class="ri-check-line"></i> è§†é¢‘å·²å°±ç»ª</div>
                                <span class="text-[10px] text-gray-400 mt-2 block">ç‚¹å‡»å¯é‡æ–°æ›¿æ¢</span>
                            </div>
                            <div v-else class="group-hover:scale-105 transition-transform">
                                <div class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-3">
                                    <i class="ri-add-line text-xl text-gray-400"></i>
                                </div>
                                <p class="text-sm font-bold text-gray-500">ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶</p>
                            </div>
                        </div>

                        <textarea v-if="form.content_type === 'text'" v-model="form.content" rows="5" placeholder="è¯·è¯¦ç»†æè¿°..." class="w-full bg-gray-50 rounded-2xl p-4 text-sm font-medium focus:bg-white focus:ring-2 focus:ring-black/5 outline-none transition-all"></textarea>
                        
                        <input v-if="form.content_type === 'link'" type="url" v-model="form.content" placeholder="https://" class="w-full bg-blue-50 text-blue-600 rounded-xl p-4 text-sm font-bold outline-none">

                        <input type="text" v-model="form.extra_note" placeholder="å¤‡æ³¨ä¿¡æ¯ (å¯é€‰)..." class="w-full text-xs py-3 border-b border-gray-100 focus:outline-none focus:border-gray-300">
                    </div>
                    
                    <button 
                        @click="submit" 
                        :disabled="!isFormValid || uploading"
                        class="w-full bg-black text-white font-bold py-4 rounded-2xl text-lg shadow-xl shadow-gray-300 hover:scale-[1.02] active:scale-95 transition-all disabled:opacity-50 disabled:transform-none"
                    >
                        {{ uploading ? 'ä¸Šä¼ å¤„ç†ä¸­...' : 'ç¡®è®¤å‘å¸ƒ' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- è¯„åˆ†å¼¹çª— (å°) -->
        <div v-if="ratingItem" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/40 backdrop-blur-sm" @click="ratingItem = null">
            <div class="bg-white p-6 rounded-2xl shadow-2xl text-center w-64 animate-[cardPopup_0.3s_ease]" @click.stop>
                <p class="text-sm font-bold text-gray-500 mb-4">ç»™è¿™æ¡æ™ºæ…§æ‰“åˆ†</p>
                <div class="flex justify-center gap-2 mb-4">
                    <button v-for="star in 5" :key="star" @click="submitRate(star)" class="text-3xl star-anim transition-colors text-gray-200 hover:text-yellow-400 focus:text-yellow-400">
                        <i class="ri-star-fill"></i>
                    </button>
                </div>
                <button @click="ratingItem = null" class="text-xs text-gray-400 underline">å–æ¶ˆ</button>
            </div>
        </div>

        <!-- è¯¦æƒ…å¼¹çª— -->
        <div v-if="detailItem" class="fixed inset-0 z-[60] flex items-center justify-center p-0 sm:p-4">
            <div class="absolute inset-0 bg-white/95 backdrop-blur-xl" @click="detailItem = null"></div>
            
            <div class="relative w-full h-full sm:h-[85vh] sm:max-w-2xl bg-white sm:rounded-3xl flex flex-col shadow-2xl overflow-hidden animate-[cardPopup_0.3s_cubic-bezier(0.16,1,0.3,1)]">
                <button @click="detailItem = null" class="absolute top-6 right-6 z-20 bg-gray-100/80 backdrop-blur text-black w-10 h-10 rounded-full flex items-center justify-center transition-transform hover:rotate-90">
                    <i class="ri-close-line text-2xl"></i>
                </button>

                <div class="overflow-y-auto h-full p-8 pb-32">
                    <div class="flex items-center gap-2 mb-6">
                         <span class="text-[10px] font-bold tracking-wider text-white bg-black px-3 py-1 rounded-full uppercase">{{ detailItem.category }}</span>
                         <span class="text-xs font-bold text-gray-400">{{ detailItem.member_name }}</span>
                    </div>
                    
                    <h1 class="text-3xl sm:text-4xl font-black text-black leading-tight mb-8">{{ detailItem.title }}</h1>

                    <div class="mb-8 rounded-2xl overflow-hidden shadow-sm border border-gray-100">
                        <img v-if="detailItem.content_type === 'image'" :src="detailItem.content" class="w-full bg-gray-50">
                        <video v-else-if="detailItem.content_type === 'video'" controls class="w-full bg-black aspect-video">
                            <source :src="detailItem.content">
                        </video>
                        <div v-else-if="detailItem.content_type === 'link'" class="p-10 bg-blue-50 text-center">
                             <a :href="detailItem.content" target="_blank" class="text-blue-600 font-bold underline text-lg break-all">{{ detailItem.content }}</a>
                        </div>
                        <div v-else class="p-6 bg-gray-50">
                            <p class="text-lg leading-relaxed text-gray-800 whitespace-pre-wrap">{{ detailItem.content }}</p>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-xl p-5 space-y-3">
                        <p class="text-xs text-gray-400 uppercase font-bold">Additional Notes</p>
                        <p class="text-sm text-gray-600">{{ detailItem.extra_note || 'æš‚æ— å¤‡æ³¨' }}</p>
                        <div class="border-t border-gray-200 pt-3 flex justify-between text-xs text-gray-400">
                            <span>ID: #{{ detailItem.id }}</span>
                            <span>{{ new Date(detailItem.created_at).toLocaleString() }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- VUE 3 & SUPABASE -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // ==========================================
        // é…ç½®åŒºï¼šè¯·æ›¿æ¢ä½ çš„ Key
        // ==========================================
        const SUPABASE_URL = 'ä½ çš„_SUPABASE_URL';
        const SUPABASE_KEY = 'ä½ çš„_SUPABASE_ANON_KEY';
        // ==========================================

        const { createApp, ref, computed, reactive, onMounted } = Vue;

        createApp({
            setup() {
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

                // æ ¸å¿ƒæ•°æ®
                const wisdomList = ref([]);
                const loading = ref(true);
                const showModal = ref(false);
                const detailItem = ref(null);
                const ratingItem = ref(null);
                const uploading = ref(false);

                // ç­›é€‰çŠ¶æ€
                const currentCategory = ref('å…¨éƒ¨');
                const currentMember = ref('å…¨éƒ¨æˆå‘˜');

                // é™æ€é…ç½®
                const members = ['çˆ·çˆ·', 'å¥¶å¥¶', 'é¢†èˆªè€…', 'å½¬å½¬æœ‰ç¤¼', 'æ™´å­è€å¸ˆ', 'å›æ˜¥ä¸¹ä¸»å”±ï¼ˆå°‘å¹´ç‰ˆï¼‰', 'å…ˆè¯»è¯´æ˜ä¹¦'];
                const availableCategories = ['ç§æˆ¿èœè°±', 'ç”Ÿæ´»å¦™æ‹›', 'å®¶åº­æ™ºæ…§', 'äººç”Ÿç»éªŒ', 'ç¾å¥½æ—¶å…‰', 'å…¶ä»–'];
                const contentTypes = [
                    { val: 'text', label: 'æ–‡å­—' }, 
                    { val: 'image', label: 'å›¾ç‰‡' }, 
                    { val: 'video', label: 'è§†é¢‘' }, 
                    { val: 'link', label: 'é“¾æ¥' }
                ];

                // è¡¨å•
                const form = reactive({
                    member_name: '', category: '', content_type: 'text', content: '', title: '', extra_note: ''
                });

                // Computed
                const categories = computed(() => ['å…¨éƒ¨', ...availableCategories]);
                const step = computed(() => {
                    if (form.member_name && form.category) return 2;
                    if (form.title) return 3;
                    return 1;
                });
                const isFormValid = computed(() => form.member_name && form.category && form.title && form.content);
                
                // åŒé‡ç­›é€‰é€»è¾‘
                const filteredList = computed(() => {
                    return wisdomList.value.filter(item => {
                        const matchCat = currentCategory.value === 'å…¨éƒ¨' || item.category === currentCategory.value;
                        const matchMem = currentMember.value === 'å…¨éƒ¨æˆå‘˜' || item.member_name === currentMember.value;
                        return matchCat && matchMem;
                    });
                });

                // --- Methods ---

                const fetchData = async () => {
                    loading.value = true;
                    const { data, error } = await supabase.from('family_wisdom').select('*').order('created_at', { ascending: false });
                    if (!error) wisdomList.value = data;
                    loading.value = false;
                };

                const resetFilters = () => {
                    currentCategory.value = 'å…¨éƒ¨';
                    currentMember.value = 'å…¨éƒ¨æˆå‘˜';
                };

                const handleUpload = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    uploading.value = true;
                    const fileName = `${Date.now()}_${file.name.replace(/[^\w\.]/g, '')}`; // ç®€å•æ¸…æ´—æ–‡ä»¶å
                    
                    const { error } = await supabase.storage.from('family_uploads').upload(fileName, file);
                    if (error) {
                        alert('ä¸Šä¼ å‡ºé”™: ' + error.message);
                        uploading.value = false;
                        return;
                    }
                    const { data: { publicUrl } } = supabase.storage.from('family_uploads').getPublicUrl(fileName);
                    form.content = publicUrl;
                    uploading.value = false;
                };

                const submit = async () => {
                    const { error } = await supabase.from('family_wisdom').insert([{
                        ...form,
                        rating_sum: 5,  // é»˜è®¤åˆå§‹åˆ†
                        rating_count: 1
                    }]);
                    if (!error) {
                        showModal.value = false;
                        // æ¸…ç©ºè¡¨å•
                        Object.assign(form, { member_name: '', category: '', content_type: 'text', content: '', title: '', extra_note: '' });
                        fetchData();
                    } else {
                        alert(error.message);
                    }
                };

                const startRating = (item) => { ratingItem.value = item; };

                const submitRate = async (score) => {
                    if (!ratingItem.value) return;
                    const item = ratingItem.value;
                    
                    // ä¹è§‚æ›´æ–° (UIå…ˆå˜)
                    item.rating_sum += score;
                    item.rating_count += 1;
                    
                    // æ•°æ®åº“æ›´æ–°
                    await supabase.from('family_wisdom').update({
                        rating_sum: item.rating_sum,
                        rating_count: item.rating_count
                    }).eq('id', item.id);

                    ratingItem.value = null;
                };

                const formatDate = (str) => {
                    const d = new Date(str);
                    return `${d.getMonth()+1}/${d.getDate()}`;
                };

                const openDetail = (item) => { detailItem.value = item; };

                onMounted(fetchData);

                return {
                    wisdomList, loading, showModal, detailItem, ratingItem, uploading,
                    currentCategory, currentMember, categories, members, availableCategories, contentTypes,
                    form, step, isFormValid, filteredList,
                    fetchData, resetFilters, handleUpload, submit, openDetail, startRating, submitRate, formatDate
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
