<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å®¶åº­æ™ºæ…§</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Remix Icon -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <style>
        /* 1. åŸºç¡€è®¾ç½® */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Arial, sans-serif; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none; /* é˜²æ­¢iOSæ©¡çš®ç­‹æ•ˆæœå½±å“ä½“éªŒ */
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* å¼ºåˆ¶è§£å†³ iOS è¾“å…¥æ¡†æ”¾å¤§é—®é¢˜ */
        input, select, textarea { font-size: 16px !important; }

        /* 2. å¯åŠ¨å±åŠ¨ç”» */
        #splash-screen {
            transition: opacity 0.6s ease-out, visibility 0.6s;
        }
        .breathing {
            animation: breathe 2s infinite ease-in-out;
        }
        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        /* 3. Vue åŠ è½½é˜²ä¹±ç  (ä¿é™©) */
        [v-cloak] { display: none !important; }

        /* 4. æ™ºèƒ½ Header éšè—åŠ¨ç”» */
        .smart-header {
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .header-hidden {
            transform: translateY(-110%);
        }

        /* 5. ç£¨ç ‚ç»ç’ƒä¸èƒŒæ™¯ */
        .glass-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .aurora-bg {
            background: radial-gradient(circle at 50% 0%, rgba(100, 180, 255, 0.15) 0%, rgba(255, 255, 255, 0) 50%),
                        radial-gradient(circle at 0% 0%, rgba(200, 100, 255, 0.05) 0%, rgba(255, 255, 255, 0) 40%);
        }

        /* 6. å¡ç‰‡å…¥åœº */
        .card-enter {
            animation: cardPopup 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            opacity: 0;
            transform: translateY(20px) scale(0.96);
        }
        @keyframes cardPopup {
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .star-anim:active { transform: scale(1.3); }
    </style>
</head>
<body class="bg-[#F2F2F7] text-[#1D1D1F] min-h-screen pb-32 aurora-bg selection:bg-blue-100">

    <!-- 0. APP å¯åŠ¨å± (çº¯é™æ€ HTMLï¼Œé®æŒ¡ Vue åŠ è½½è¿‡ç¨‹) -->
    <div id="splash-screen" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center">
        <div class="breathing flex flex-col items-center">
            <i class="ri-home-heart-fill text-6xl text-blue-500 mb-4"></i>
            <h1 class="text-2xl font-black tracking-widest text-black">å®¶åº­æ™ºæ…§</h1>
            <p class="text-xs text-gray-400 mt-2 font-mono uppercase tracking-[0.3em]">Loading Wisdom...</p>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ (åŠ äº† v-cloak é˜²æ­¢é—ªçƒ) -->
    <div id="app" v-cloak>
        
        <!-- 1. æ™ºèƒ½ Header (æ ¹æ® showHeader çŠ¶æ€å†³å®šæ˜¾éš) -->
        <header 
            class="fixed top-0 left-0 right-0 z-40 glass-nav pt-safe-top smart-header shadow-sm"
            :class="{ 'header-hidden': !showHeader }"
        >
            <!-- æ ‡é¢˜æ  -->
            <div class="px-6 pt-3 pb-2 text-center relative flex justify-center items-center">
                <h1 class="text-xl font-black tracking-tight text-black flex items-center gap-2">
                    <i class="ri-home-heart-fill text-blue-500 text-lg"></i> å®¶åº­æ™ºæ…§
                </h1>
            </div>

            <!-- ç­›é€‰åŒº -->
            <div class="px-4 pb-3">
                <!-- ç¬¬ä¸€è¡Œï¼šåˆ†ç±» -->
                <div class="flex flex-wrap justify-center gap-2 mb-2">
                    <button 
                        v-for="cat in categories" 
                        :key="cat"
                        @click="currentCategory = cat; scrollToTop()"
                        class="px-3 py-1.5 rounded-full text-xs font-bold transition-all duration-200 border"
                        :class="currentCategory === cat 
                            ? 'bg-black text-white border-black shadow-md' 
                            : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'"
                    >
                        {{ cat }}
                    </button>
                </div>

                <!-- ç¬¬äºŒè¡Œï¼šæˆå‘˜ç­›é€‰ -->
                <div class="flex justify-center">
                    <div class="relative inline-block w-full max-w-[160px]">
                        <select v-model="currentMember" @change="scrollToTop()" class="w-full appearance-none bg-gray-100/50 border-0 rounded-lg pl-3 pr-8 py-1.5 text-xs font-bold text-gray-600 focus:outline-none text-center">
                            <option value="å…¨éƒ¨æˆå‘˜">ğŸ‘¤ å…¨éƒ¨æˆå‘˜</option>
                            <option v-for="m in members" :value="m">{{ m }}</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-2 flex items-center text-gray-400">
                            <i class="ri-arrow-down-s-fill text-xs"></i>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- å ä½ç¬¦ï¼Œé˜²æ­¢å†…å®¹è¢« Header é®æŒ¡ (é«˜åº¦æ ¹æ® Header ä¼°ç®—) -->
        <div class="h-32"></div>

        <!-- 2. åˆ—è¡¨åŒºåŸŸ -->
        <main class="px-4 pb-4 space-y-4 max-w-xl mx-auto min-h-screen">
            
            <!-- ç©ºçŠ¶æ€ -->
            <div v-if="!loading && filteredList.length === 0" class="text-center py-20 opacity-40">
                <div class="bg-white w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm">
                    <i class="ri-inbox-line text-3xl text-gray-300"></i>
                </div>
                <p class="text-sm text-gray-400 font-bold">æš‚æ— ç›¸å…³è®°å½•</p>
                <button @click="resetFilters" class="text-blue-500 text-xs mt-2 font-bold bg-blue-50 px-3 py-1 rounded-full">æ˜¾ç¤ºå…¨éƒ¨</button>
            </div>

            <!-- å¡ç‰‡ -->
            <div 
                v-for="(item, index) in filteredList" 
                :key="item.id"
                class="card-enter bg-white rounded-[20px] shadow-[0_2px_20px_rgba(0,0,0,0.03)] overflow-hidden cursor-pointer active:scale-[0.98] transition-transform duration-200 border border-white"
                :style="{ animationDelay: index * 0.05 + 's' }"
                @click="openDetail(item)"
            >
                <!-- å¡ç‰‡å°é¢ -->
                <div v-if="item.content_type === 'image'" class="h-48 w-full bg-gray-100 relative overflow-hidden">
                    <img :src="item.content" class="w-full h-full object-cover">
                </div>
                <div v-else-if="item.content_type === 'video'" class="h-48 w-full bg-black relative flex items-center justify-center">
                    <i class="ri-play-circle-fill text-white text-5xl opacity-80 backdrop-blur-sm rounded-full"></i>
                </div>

                <!-- å¡ç‰‡æ–‡æœ¬ -->
                <div class="p-5">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded">{{ item.category }}</span>
                        <span class="text-[10px] text-gray-300 font-mono">{{ formatDate(item.created_at) }}</span>
                    </div>

                    <h3 class="text-lg font-black text-[#1D1D1F] leading-tight mb-2 line-clamp-2">{{ item.title }}</h3>
                    
                    <p v-if="item.content_type === 'text'" class="text-sm text-gray-500 line-clamp-3 mb-3 leading-relaxed">
                        {{ item.content }}
                    </p>

                    <div class="flex items-center justify-between pt-3 border-t border-gray-50 mt-1">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-[10px] font-bold text-gray-400">
                                {{ item.member_name.charAt(0) }}
                            </div>
                            <span class="text-xs font-bold text-gray-500">{{ item.member_name }}</span>
                        </div>

                        <div class="flex items-center gap-1 bg-yellow-50/50 px-2 py-0.5 rounded-md" @click.stop="startRating(item)">
                            <i class="ri-star-fill text-yellow-400 text-xs"></i>
                            <span class="text-xs font-bold text-gray-600">{{ (item.rating_sum / (item.rating_count || 1)).toFixed(1) }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 3. æ‚¬æµ®æŒ‰é’® (è·Ÿéš Header é€»è¾‘ï¼Œä¹Ÿå¯å•ç‹¬è®¾ç½®) -->
        <div class="fixed bottom-10 left-0 right-0 flex justify-center z-40 pointer-events-none transition-transform duration-500" :class="{'translate-y-24': !showHeader}">
            <button 
                @click="openAddModal"
                class="pointer-events-auto bg-[#1D1D1F] text-white pl-5 pr-6 py-3.5 rounded-full shadow-2xl flex items-center gap-3 active:scale-90 transition-all duration-300 hover:bg-black"
            >
                <div class="w-6 h-6 rounded-full bg-white text-black flex items-center justify-center">
                    <i class="ri-add-line font-bold"></i>
                </div>
                <span class="font-bold text-sm tracking-wide">è®°å½•æ–°æ™ºæ…§</span>
            </button>
        </div>

        <!-- 4. å‘å¸ƒå¼¹çª— -->
        <div v-if="showModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-md transition-opacity" @click="closeModal"></div>
            
            <div class="bg-[#F9F9FB] w-full h-[95vh] sm:h-auto sm:max-w-lg sm:rounded-3xl rounded-t-[32px] shadow-2xl z-10 flex flex-col overflow-hidden animate-[cardPopup_0.4s_cubic-bezier(0.16,1,0.3,1)]">
                <div class="pt-5 pb-3 px-6 border-b border-gray-200/50 flex justify-between items-center bg-white/80 backdrop-blur z-20 sticky top-0">
                    <h2 class="text-lg font-black text-black">è®°å½•æ™ºæ…§</h2>
                    <button @click="closeModal" class="bg-gray-100 text-gray-500 rounded-full w-8 h-8 flex items-center justify-center hover:bg-gray-200">
                        <i class="ri-close-line text-lg"></i>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-6 space-y-6 pb-32">
                    <div class="space-y-3">
                        <p class="text-xs font-black text-gray-400 uppercase tracking-widest">åŸºç¡€ä¿¡æ¯</p>
                        <div class="grid grid-cols-2 gap-4">
                            <select v-model="form.member_name" class="bg-white border-0 rounded-2xl p-4 text-sm font-bold shadow-sm">
                                <option value="" disabled>æˆ‘æ˜¯è°?</option>
                                <option v-for="m in members" :value="m">{{ m }}</option>
                            </select>
                            <select v-model="form.category" class="bg-white border-0 rounded-2xl p-4 text-sm font-bold shadow-sm">
                                <option value="" disabled>åˆ†ç±»?</option>
                                <option v-for="c in availableCategories" :value="c">{{ c }}</option>
                            </select>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <p class="text-xs font-black text-gray-400 uppercase tracking-widest">å†…å®¹å½¢å¼</p>
                        <div class="flex bg-gray-200/60 p-1 rounded-xl">
                            <button v-for="type in contentTypes" @click="form.content_type = type.val" class="flex-1 py-2.5 rounded-lg text-xs font-bold transition-all" :class="form.content_type === type.val ? 'bg-white shadow text-black' : 'text-gray-500'">{{ type.label }}</button>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <input type="text" v-model="form.title" placeholder="è¾“å…¥æ ‡é¢˜..." class="w-full text-xl font-black bg-transparent border-b-2 border-gray-100 py-2 focus:border-black outline-none placeholder-gray-300">
                        
                        <div v-if="['image','video'].includes(form.content_type)" class="border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center bg-white relative overflow-hidden">
                            <input type="file" @change="handleUpload" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            <div v-if="uploading" class="text-blue-500 font-bold text-xs animate-pulse">ä¸Šä¼ ä¸­...</div>
                            <div v-else-if="form.content">
                                <img v-if="form.content_type==='image'" :src="form.content" class="h-32 object-contain mx-auto">
                                <span v-else class="text-green-500 font-bold text-xs">è§†é¢‘å·²å°±ç»ª</span>
                            </div>
                            <div v-else class="text-gray-400 text-sm font-bold flex flex-col items-center gap-2">
                                <i class="ri-upload-cloud-line text-2xl"></i> ç‚¹å‡»ä¸Šä¼ 
                            </div>
                        </div>

                        <textarea v-if="form.content_type === 'text'" v-model="form.content" rows="5" placeholder="å†™ç‚¹ä»€ä¹ˆ..." class="w-full bg-white rounded-2xl p-4 text-base shadow-sm outline-none"></textarea>
                        <input v-if="form.content_type === 'link'" type="url" v-model="form.content" placeholder="https://" class="w-full bg-blue-50 text-blue-600 rounded-2xl p-4 text-sm font-bold outline-none">
                        
                        <input type="text" v-model="form.extra_note" placeholder="å¤‡æ³¨..." class="w-full text-sm py-2 border-b border-gray-200 bg-transparent outline-none">
                    </div>
                    
                    <button @click="submit" :disabled="!isFormValid || uploading" class="w-full bg-[#1D1D1F] text-white font-bold py-4 rounded-2xl shadow-xl active:scale-95 transition-all disabled:opacity-50">å‘å¸ƒ</button>
                </div>
            </div>
        </div>

        <!-- è¯„åˆ†å¼¹çª— -->
        <div v-if="ratingItem" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/40 backdrop-blur-sm" @click="ratingItem = null">
            <div class="bg-white p-6 rounded-3xl shadow-2xl text-center w-64 animate-[cardPopup_0.2s_ease]" @click.stop>
                <p class="text-sm font-bold text-gray-800 mb-4">æ‰“åˆ†</p>
                <div class="flex justify-center gap-2 mb-4">
                    <button v-for="star in 5" :key="star" @click="submitRate(star)" class="text-3xl star-anim transition-colors text-gray-200 hover:text-yellow-400 focus:text-yellow-400"><i class="ri-star-fill"></i></button>
                </div>
            </div>
        </div>

        <!-- è¯¦æƒ…å¼¹çª— -->
        <div v-if="detailItem" class="fixed inset-0 z-[60] flex items-center justify-center p-0 sm:p-4">
            <div class="absolute inset-0 bg-white/95 backdrop-blur-xl" @click="closeDetail"></div>
            <div class="relative w-full h-full sm:h-[90vh] sm:max-w-2xl bg-white sm:rounded-[32px] flex flex-col shadow-2xl overflow-hidden animate-[cardPopup_0.3s_cubic-bezier(0.16,1,0.3,1)]">
                <button @click="closeDetail" class="absolute top-5 right-5 z-20 bg-gray-100/80 backdrop-blur text-black w-9 h-9 rounded-full flex items-center justify-center"><i class="ri-close-line text-xl"></i></button>

                <div class="overflow-y-auto h-full p-6 pb-32">
                    <div class="flex items-center gap-2 mb-4">
                         <span class="text-[10px] font-bold tracking-wider text-white bg-black px-2 py-1 rounded-md uppercase">{{ detailItem.category }}</span>
                         <span class="text-xs font-bold text-gray-400">{{ detailItem.member_name }}</span>
                    </div>
                    <h1 class="text-2xl sm:text-3xl font-black text-black leading-tight mb-6">{{ detailItem.title }}</h1>
                    
                    <div class="mb-6 rounded-2xl overflow-hidden shadow-sm border border-gray-100">
                        <img v-if="detailItem.content_type === 'image'" :src="detailItem.content" class="w-full">
                        <video v-else-if="detailItem.content_type === 'video'" controls class="w-full bg-black aspect-video"><source :src="detailItem.content"></video>
                        <div v-else-if="detailItem.content_type === 'link'" class="p-8 bg-blue-50 text-center"><a :href="detailItem.content" target="_blank" class="text-blue-600 font-bold underline break-all">{{ detailItem.content }}</a></div>
                        <div v-else class="p-5 bg-gray-50/50"><p class="text-lg leading-relaxed text-gray-800 whitespace-pre-wrap">{{ detailItem.content }}</p></div>
                    </div>

                    <div class="bg-gray-50 rounded-2xl p-5 space-y-2">
                        <p class="text-xs text-gray-400 uppercase font-black">å¤‡æ³¨</p>
                        <p class="text-sm text-gray-600">{{ detailItem.extra_note || 'æ— ' }}</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // ==========================================
        const SUPABASE_URL = 'https://ugoksbtsjoktcmueyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnb2tzYnRzam9rdGNtdWttZXVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNjYyMDYsImV4cCI6MjA4Njg0MjIwNn0.11Vc-X5Y6qbGqOk6ydbb65VrEBYsuGRwLlQnj4nsVeAä½ çš„_SUPABASE_ANON_KEY';
        // ==========================================

        const { createApp, ref, computed, reactive, onMounted, onUnmounted } = Vue;

        createApp({
            setup() {
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                const wisdomList = ref([]);
                const loading = ref(true);
                const showModal = ref(false);
                const detailItem = ref(null);
                const ratingItem = ref(null);
                const uploading = ref(false);
                const currentCategory = ref('å…¨éƒ¨');
                const currentMember = ref('å…¨éƒ¨æˆå‘˜');
                
                // Header æ™ºèƒ½æ˜¾éšé€»è¾‘
                const showHeader = ref(true);
                const lastScrollTop = ref(0);

                const members = ['çˆ·çˆ·', 'å¥¶å¥¶', 'é¢†èˆªè€…', 'å½¬å½¬æœ‰ç¤¼', 'æ™´å­è€å¸ˆ', 'å›æ˜¥ä¸¹ä¸»å”±ï¼ˆå°‘å¹´ç‰ˆï¼‰', 'å…ˆè¯»è¯´æ˜ä¹¦'];
                const availableCategories = ['ç§æˆ¿èœè°±', 'ç”Ÿæ´»å¦™æ‹›', 'å®¶åº­æ™ºæ…§', 'äººç”Ÿç»éªŒ', 'ç¾å¥½æ—¶å…‰', 'å…¶ä»–'];
                const contentTypes = [{ val: 'text', label: 'æ–‡å­—' }, { val: 'image', label: 'å›¾ç‰‡' }, { val: 'video', label: 'è§†é¢‘' }, { val: 'link', label: 'é“¾æ¥' }];
                const form = reactive({ member_name: '', category: '', content_type: 'text', content: '', title: '', extra_note: '' });

                const categories = computed(() => ['å…¨éƒ¨', ...availableCategories]);
                const isFormValid = computed(() => form.member_name && form.category && form.title && form.content);
                const filteredList = computed(() => wisdomList.value.filter(item => (currentCategory.value === 'å…¨éƒ¨' || item.category === currentCategory.value) && (currentMember.value === 'å…¨éƒ¨æˆå‘˜' || item.member_name === currentMember.value)));

                // æ ¸å¿ƒé€»è¾‘
                const handleScroll = () => {
                    const st = window.pageYOffset || document.documentElement.scrollTop;
                    if (st < 0) return; // iOS å¼¹æ€§æ»šåŠ¨å¤„ç†
                    
                    // åªæœ‰æ»šåŠ¨è¶…è¿‡ 60px ä¸”å‘ä¸‹æ»šæ‰éšè—ï¼Œå‘ä¸Šæ»šç«‹åˆ»æ˜¾ç¤º
                    if (Math.abs(st - lastScrollTop.value) > 10) {
                        showHeader.value = st < lastScrollTop.value || st < 50;
                        lastScrollTop.value = st;
                    }
                };
                
                const scrollToTop = () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };

                const fetchData = async () => {
                    loading.value = true;
                    const { data, error } = await supabase.from('family_wisdom').select('*').order('created_at', { ascending: false });
                    if (!error) wisdomList.value = data;
                    loading.value = false;
                    
                    // æ•°æ®åŠ è½½å®Œï¼Œæ·¡å‡ºå¯åŠ¨å±
                    setTimeout(() => {
                        const splash = document.getElementById('splash-screen');
                        if(splash) {
                            splash.style.opacity = '0';
                            splash.style.visibility = 'hidden';
                        }
                    }, 500);
                };

                // å†å²è®°å½•å¤„ç† (å·¦æ»‘è¿”å›)
                window.addEventListener('popstate', () => {
                    if (detailItem.value) detailItem.value = null;
                    else if (showModal.value) showModal.value = false;
                });
                const openDetail = (item) => { history.pushState({modal:'detail'},null,''); detailItem.value = item; };
                const closeDetail = () => { history.back(); };
                const openAddModal = () => { history.pushState({modal:'add'},null,''); showModal.value = true; };
                const closeModal = () => { history.back(); };

                // ä¸šåŠ¡åŠŸèƒ½
                const resetFilters = () => { currentCategory.value = 'å…¨éƒ¨'; currentMember.value = 'å…¨éƒ¨æˆå‘˜'; };
                const handleUpload = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    uploading.value = true;
                    const fileName = `${Date.now()}_${file.name.replace(/[^\w\.]/g, '')}`;
                    const { error } = await supabase.storage.from('family_uploads').upload(fileName, file);
                    if (error) { alert('å¤±è´¥: ' + error.message); uploading.value = false; return; }
                    const { data: { publicUrl } } = supabase.storage.from('family_uploads').getPublicUrl(fileName);
                    form.content = publicUrl; uploading.value = false;
                };
                const submit = async () => {
                    const { error } = await supabase.from('family_wisdom').insert([{ ...form, rating_sum: 5, rating_count: 1 }]);
                    if (!error) { history.back(); Object.assign(form, {member_name:'', category:'', content_type:'text', content:'', title:'', extra_note:''}); fetchData(); }
                };
                const startRating = (item) => ratingItem.value = item;
                const submitRate = async (score) => {
                    if(!ratingItem.value) return;
                    const item = ratingItem.value;
                    item.rating_sum += score; item.rating_count += 1;
                    await supabase.from('family_wisdom').update({rating_sum:item.rating_sum, rating_count:item.rating_count}).eq('id',item.id);
                    ratingItem.value = null;
                };
                const formatDate = (str) => { const d = new Date(str); return `${d.getMonth()+1}/${d.getDate()}`; };

                onMounted(() => {
                    fetchData();
                    window.addEventListener('scroll', handleScroll);
                });
                onUnmounted(() => {
                    window.removeEventListener('scroll', handleScroll);
                });

                return {
                    wisdomList, loading, showModal, detailItem, ratingItem, uploading,
                    currentCategory, currentMember, categories, members, availableCategories, contentTypes,
                    form, isFormValid, filteredList, showHeader,
                    resetFilters, handleUpload, submit, openDetail, closeDetail, openAddModal, closeModal, 
                    startRating, submitRate, formatDate, scrollToTop
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
